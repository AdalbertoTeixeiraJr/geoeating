<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&language=pt-BR"></script>
<script type="text/javascript">
var map;
var directionDisplay;
var directionsService;
var tempDest;

var op;
var fonte;
var destino;

function initialize() {

    directionsDisplay = new google.maps.DirectionsRenderer();
    directionsService = new google.maps.DirectionsService();
    
    var latlng = new google.maps.LatLng(-7.231018,-35.881348);
    tempDest = new google.maps.Marker({
                        position: event.latLng, 
                        map: null,
                        title: "Origem"
            });
    
    var myOptions = {
      zoom: 14,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    
    google.maps.event.addListener(map, 'click', function(event) {
        limpa();
        if(op == 1){
            placeMarker(event.latLng);
            op = 0;
            fonte = -1;
            destino = -1;
        }else if(op == 2){
            tempDest = new google.maps.Marker({
                        position: event.latLng, 
                        map: map,
                        title: "Origem"
            });
            fonte = event.latLng;
        }
    });
}
  
function placeMarker(location) {
  var clickedLocation = new google.maps.LatLng(location);
  var marker = new google.maps.Marker({
      position: location, 
      map: map,
      title: "Restaurante",
      icon: "http://dl.dropbox.com/u/9776816/rest.png"
  });
 
  google.maps.event.addListener(marker, 'click', function(event) {
      if(op == 2){
            destino = event.latLng;
            if(fonte != -1){
                 calcRoute(fonte, destino);
            }
      }  
  });
  map.setCenter(location);
  
}

function limpa(){
  directionsDisplay.setMap(null);
  directionsDisplay.setPanel(null);
  tempDest = null;
}

function novoRestaurante(){
  limpa();
  op = 1;
}

function calculaRota(){
  limpa();
  fonte = -1;
  destino = -1;
  op = 2;
}

function calcRoute(fonte, destino) {
  directionsDisplay.setMap(map);
  directionsDisplay.setPanel(document.getElementById("directionsPanel"));
  var request = {
      origin: fonte, 
      destination: destino,
      travelMode: google.maps.DirectionsTravelMode.DRIVING
  };
  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    }
  });
  op = 0;
  apagaTemp();
}

function apagaTemp(){
  tempDest.setMap(null);
}

</script>

</head>
<body onload="initialize()">
  <div><div id="map_canvas" style="float:left;width:70%; height:100%"></div>
  <div id="directionsPanel" style="float:right;width:30%;height 100%"></div> 
  <input type="button" value="Adicionar Restaurante" name="buttonAddRest", onClick="novoRestaurante()" > 
  <input type="button" value="Calcular Rota" name="buttonCalcRota", onClick="calculaRota()" > 
</body>
</html>