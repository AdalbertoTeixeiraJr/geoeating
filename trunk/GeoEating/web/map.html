<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1" />
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>GEO Eating</title>
<link rel="stylesheet" type="text/css" href="css/buttons.css" />
<style type="text/css">
html,body,#map_canvas {
	width: 100%;
	height: 100%;
	margin: 0;
	padding: 0;
}
</style>
<script type="text/javascript"
	src="http://maps.google.com/maps/api/js?sensor=false&language=pt-BR"></script>
<script type="text/javascript"
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.0/jquery.min.js"></script>
<script type="text/javascript">
var lastClick;
var customMapType;
var rasterOptions;
var layers = [];
var workspace = "geoeating";

function updateMapLayers(){
	if(layers.length>0){
		limpaPlacemarks();
		for(i in layers){
			pegaLayer(workspace,layers[i]);
		}
	}
}

function limpaPlacemarks(){
	for(j in restaurantes){
		restaurantes[j].setMap(null);
	}

	restaurantes = [];
}

function callbackWFS(responseXML, status,workspace,layer){
	var wfsCollection = responseXML.firstChild;
	if(wfsCollection.nodeName == "wfs:FeatureCollection"){
		var wfsChilds = wfsCollection.childNodes;
		for(var i=0;i<wfsChilds.length;i++){
			var node = wfsChilds.item(i);
			if(node.nodeName == "gml:featureMember"){
				var camada = node.firstChild;
				if(camada.nodeName == workspace+":"+layer){
					addPlacemarkRestaurant(camada,workspace);
				}
			}
		}
	}
}

function addPlacemarkRestaurant(node,workspace){
	var htmlDescription = '<table>';
	var childNodes = node.childNodes;
	var lat; var lon;

	for(var i=0;i<childNodes.length;i++){
		var child = childNodes.item(i);
		if(child.nodeName == workspace+":geom"){
			if(child.firstChild.firstChild){
				var coords = child.firstChild.firstChild;
				if(coords.nodeName == "gml:coordinates"){
					var coord = coords.textContent.split(",");
					lon = new Number(coord[0]);
					lat = new Number(coord[1]);
				}
			}
		}
	}
	htmlDescription = htmlDescription+'</table>';
	var location = new google.maps.LatLng(lat,lon);
	var marker = new google.maps.Marker({
		position : location,
		map : map,
		title : "Restaurante",
		icon : "images/rest.png"
	});

	google.maps.event.addListener(marker, 'click', function(event) {
		if (op == 2) {
			destino = event.latLng;
			if (fonte != -1) {
				calcRoute(fonte, destino);
			}
		}
	});
	//map.setCenter(location);
	restaurantes.push(marker);
}

function pegaLayer(workspace,camada){
	var bbox = getBbox();
	var layer = workspace+":"+camada;
	var url = "http://localhost:8080/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName="+layer+"&styles=&bbox="+bbox;
	url = url+"&srs=EPSG:4326";
	downloadUrl(url,
			    callbackWFS, null,workspace,camada);
}

function abreCadastro() {
	window
			.open(
					'cadastraPop.html',
					'mywindow', 'width=600,height=300');
}

function getBbox(){
	var bounds = map.getBounds();
	var coords = bounds.toUrlValue(4).split(",");
	var aux = coords[0];
	coords[0] = coords[1];
	coords[1] = aux;

	aux = coords[2];
	coords[2] = coords[3];
	coords[3] = aux;
	return coords.toString();
	
}

function addLayer(input,layer){
	var checked = input.checked;
	for(i in layers){
		if(layers[i] == layer){
			layers.splice(i,1);
		}
	}
	if(checked){
		layers.push(layer);
	}

	updateMapLayers();
}


/*
 * 
	if(!customMapType){
		var rasterOptions = {
			     getTileUrl: function(coord, zoom) {
			       return "http://localhost:8080/geoserver/gwc/service/gmaps?layers=geoeating:restaurant&gridSet=EPSG:4326" +
			        "&zoom=" + zoom + "&x=" + coord.x + "&y=" + coord.y + "&format=image/png";
			     },
			     tileSize: new google.maps.Size(256,256),
			     isPng: true,
			     opacity: 0.9,
			  	 minZoom: 13,
			     name: "Restaurantes",
			     alt: "Restaurantes"
			 };

			customMapType = new google.maps.ImageMapType(rasterOptions);
			map.overlayMapTypes.insertAt(0, customMapType);
	}else{
		map.overlayMapTypes.removeAt(0);
		customMapType = null;
	}
 */

</script>
<script type="text/javascript" src="js/geoeating.js"></script>
<script type="text/javascript" src="js/util.js"></script>
</head>
<body onLoad="initialize()">
	<table style="width: 100%; height: 100%" border="1">
		<tr>
			<td id="map_column" style="width: 70%; height: 100%">
				<div id="map_canvas" style="width: 100%; height: 100%"></div>
			</td>
			<td style="width: 30%; height: 100%" align="center">
				<div id="map_control" style="width: 100%; height: 100%;">
					<table style="width: 100%; height: 20%">
						<tr align="center">
							<td align="center">
								<h1>GEO Eating</h1>
								<div class="buttons">
									<button type="submit" class="positive" onclick="novoRestaurante()">
										<img src="images/add.png" alt="" /> Adicionar restaurante
									</button>
									<button type="submit" class="positive" onclick="calculaRota()">
										<img src="images/routing.png" alt="" /> Calcular rota
									</button>
									<button type="submit" class="positive" onclick="restaurantesProximos()">
										<img src="images/around.png" alt="" /> Encontrar restaurantes pr&oacute;ximos
									</button>
									<button type="submit" class="positive" onclick="procurarPorEnd()">
										<img src="images/find.png" alt="" /> Procurar por endere&ccedil;o
									</button>
									<input type="checkbox" onchange="addLayer(this,'restaurant')" id="checkRestaurantsLayer" />Restaurantes
									<input type="button" onclick="updateMapLayers()" value="UpdateMap"/>
								</div>
							</td>
						</tr>
					</table>
					<div id="directionsPanel"></div>
				</div>
			</td>
		</tr>
	</table>
</body>
</html>